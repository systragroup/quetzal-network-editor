<!-- eslint-disable vue/multi-word-component-names -->
<script>
import auth from '../../auth'
import { cognitoClient } from '@src/axiosClient.js'
const $gettext = s => s

export default {
  name: 'Profile',
  components: {

  },

  props: [],
  events: ['logout'],
  data () {
    return {
      menu: false,
      showDialog: false,
      action: 'login',
      showMore: false,
      groups: [],
      users: [],
      selectedGroup: null,
      userForm: { username: '', given_name: '', family_name: '', email: '', password: '' },
      re: /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]+$/,
      rules: {
        required: v => !!v || $gettext('Required'),
        email: v => v.includes('@') || $gettext('invalid email address'),
        length: v => v.length > 8 || $gettext('at least 8 character long'),
        password: v => this.re.test(v) || $gettext('need at least: 1 lowercase, 1 uppercase, 1 number, and 1 symbol'),
      },
    }
  },
  computed: {
    projectIsEmpty () { return this.$store.getters.projectIsEmpty },
    loggedIn () { return this.$store.getters.loggedIn },
    cognitoInfo () { return this.$store.getters.cognitoInfo },
    bucketList () { return this.$store.getters.bucketList },

    initial () { return (this.cognitoInfo?.given_name[0] + this.cognitoInfo?.family_name[0]).toUpperCase() },
  },
  watch: {
    async menu (val) {
      if (val) {
        await this.listGroup()
        if (!this.selectedGroup) this.selectedGroup = this.groups[0]
        await this.listUser(this.selectedGroup)
      }
    },
    async selectedGroup (newVal, oldVal) {
      if (oldVal) {
        await this.listUser(this.selectedGroup)
      }
    },

  },

  methods: {
    async listGroup () {
      try {
        const resp = await cognitoClient.client.get('listGroups/')
        this.groups = resp.data
      } catch (err) {
        this.$store.commit('changeAlert',
          { name: 'Cognito Client error', message: err.response.data.detail })
      }
    },
    async listUser (group) {
      try {
        const resp = await cognitoClient.client.get(`listUser/${group}/`)
        this.users = resp.data
      } catch (err) {
        this.$store.commit('changeAlert',
          { name: 'Cognito Client error', message: err.response.data.detail })
      }
    },
    async createUser () {
      try {
        await cognitoClient.client.post(`createUser/${this.selectedGroup}/`, this.userForm)
      } catch (err) {
        this.$store.commit('changeAlert',
          { name: 'Cognito Client error', message: err.response.data.detail })
      }
    },
    resetPassword (user) { console.log(user) },

    createUserButton () {
      this.action = 'createUser'
      this.showDialog = true
    },

    toggleShowMore () { this.showMore = !this.showMore },

    login () {
      if (this.projectIsEmpty) {
        auth.login()
      } else {
        this.action = 'login'
        this.showDialog = true
      }
    },
    logout () {
      if (this.projectIsEmpty) {
        this.menu = false
        auth.logout()
      } else {
        this.action = 'logout'
        this.showDialog = true
      }
    },
    async applyDialog () {
      if (this.action === 'login') auth.login()
      if (this.action === 'logout') auth.logout()
      if (this.action === 'createUser') {
        if (!this.$refs.form.validate()) { return }
        await this.createUser()
      }
      this.menu = false
      this.showDialog = false
    },

  },
}
</script>
<template>
  <section>
    <v-menu
      v-if="loggedIn"
      v-model="menu"
      :close-on-content-click="false"
      :close-on-click="false"
      :nudge-width="200"
      offset-x
      offset-y
    >
      <template v-slot:activator="{ on, attrs }">
        <v-avatar
          size="34"
          color="primary"
          v-bind="attrs"
          v-on="on"
        >
          <span class="white--text text-h6">{{ initial }}</span>
        </v-avatar>
      </template>
      <v-card>
        <v-list>
          <v-list-item>
            <v-list-item-content>
              <v-list-item-title>{{ cognitoInfo.given_name+' '+ cognitoInfo.family_name }}</v-list-item-title>
              <v-list-item-subtitle>{{ cognitoInfo.email }}</v-list-item-subtitle>
            </v-list-item-content>
          </v-list-item>
        </v-list>

        <v-divider />
        <v-list-item>
          <v-list-item-content>
            <v-select
              v-model="selectedGroup"
              :label="$gettext('Team')"
              :disabled="groups.length <= 1"
              :items="groups"
            />
          </v-list-item-content>
        </v-list-item>

        <v-divider />
        <v-list-item
          v-for="user in users"
          :key="user.Username"
        >
          <v-list-item-content>
            <v-list-item-title>{{ user.Username }}</v-list-item-title>
            <v-list-item-subtitle>
              {{ user.email }}
            </v-list-item-subtitle>
            <v-list-item-subtitle
              v-if="false"
              :style="{'cursor': 'pointer'}"
              @click="resetPassword(user)"
            >
              {{ $gettext('reset password') }}
            </v-list-item-subtitle>
          </v-list-item-content>
        </v-list-item>
        <v-card-actions>
          <v-btn
            color="success"
            outlined
            @click="createUserButton"
          >
            {{ $gettext('create user') }}
          </v-btn>
        </v-card-actions>
        <v-divider />

        <v-card-actions>
          <v-btn
            icon
            x-small
            @click="toggleShowMore"
          >
            <v-icon v-if="showMore">
              fas fa-minus-circle fa-rotate-90
            </v-icon>
            <v-icon v-else>
              fas fa-minus-circle
            </v-icon>
          </v-btn>
          <v-spacer />

          <v-btn
            color="primary"
            text
            @click="logout"
          >
            {{ $gettext('logout') }}
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-menu>
    <v-tooltip
      v-else
      bottom
      open-delay="250"
    >
      <template v-slot:activator="{ on, attrs }">
        <v-btn
          icon
          v-bind="attrs"
          v-on="on"
          @click="login"
        >
          <v-icon>
            fas fa-sign-in-alt
          </v-icon>
        </v-btn>
      </template>
      <span>{{ $gettext('login / signin') }}</span>
    </v-tooltip>
    <v-dialog
      v-model="showDialog"
      persistent
      max-width="350"
      @keydown.enter="applyDialog"
      @keydown.esc="()=>showDialog=false"
    >
      <v-card>
        <v-card-title class="text-h4">
          {{ action==='login'? $gettext("Redirect"):$gettext('Create User') }}
        </v-card-title>
        <v-card-text class="text-h8">
          {{ action==='login'? $gettext("This will ERASE the current project"):
            'create a new user in your user group. Please shared the temporary password with him/her as the invitation email could be blocked by the organization' }}
        </v-card-text>
        <v-form
          v-if="action=='createUser'"
          ref="form"
          class="form"
          lazy-validation
        >
          <v-text-field
            v-model="userForm.username"
            :label="$gettext('username')"
            :rules="[rules['required']]"
            required
          />
          <v-text-field
            v-model="userForm.given_name"
            :label="$gettext('first name')"
            :rules="[rules['required']]"
            required
          />
          <v-text-field
            v-model="userForm.family_name"
            :rules="[rules['required']]"
            :label="$gettext('last name')"
            required
          />
          <v-text-field
            v-model="userForm.email"
            :rules="[rules['required'], rules['email']]"
            :label="$gettext('email address')"
            required
          />
          <v-text-field
            v-model="userForm.password"
            :label="$gettext('temporary password')"
            :rules="[rules['required'], rules['length'], rules['password']]"
            required
          />
        </v-form>
        <v-card-actions>
          <v-spacer />
          <v-btn
            color="regular"
            @click="()=>showDialog = !showDialog"
          >
            {{ $gettext("No") }}
          </v-btn>

          <v-btn
            color="primary"
            @click="applyDialog"
          >
            {{ $gettext("Yes") }}
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </section>
</template>
<style lang="scss" scoped>
.form{
  margin: 1rem;
}
</style>
